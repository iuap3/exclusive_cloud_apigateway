# API开发者

API开发者是系统内置角色可以将开发的API发布到API网关中，供使用者调用。API开发者门户为服务API开发者提供服务开放能力。

## 服务管理

服务管理提供了API创建、维护、发布、运行等生命周期的管理工作。

### 添加服务

在服务管理页签，选择【添加服务】按钮。

![添加服务](/articles/apigateway/5-/images/img3.1.1-1.png)

填写服务名称、英文名称、服务描述，并选择服务分类和开通方式。当开通方式为自动时，使用者在API中心申请API时，可以直接使用。若开通方式为手动时，使用者在API中心申请API后，需要开发者进行服务审核操作，具体细节参照服务审核。填写完成后保存，此时服务已经添加完成。

### 添加API

服务添加完成后，再添加服务下的API。选择【添加API】可进入API信息页签进行API创建。

![添加API页面](/articles/apigateway/5-/images/img3.1.2-1.png)

* API基本信息

填写API名称、英文名称和流量访问控制。其中流量访问控制的设置包含每个用户访问次数和API访问次数。流量控制的具体说明详见流量控制。

* 请求方式

请求方式信息分为GET、POST

当请求方式选择POST时，需要填写Content-Type，具体说明见页面类型参考。
请求示例可以选择默认示例或者自定义示例。

* 输入参数配置

**接入方式** 有Http_url和Rpc方式

若选择接入方式为Http_url则需要填写API的访问路径。API 网关对入参的处理模式，支持入参映射和入参透传两种模式。
若选择RPC接入方式，目前RPC支持的参数类型参考RPC参数支持文档。

**入参映射：** 即 API 网关在接收到您的 API 请求时，通过映射关系将请求转换成您后端需要的格式。

使用入参映射模式的特点：

定义方式：定义此类 API 时，需添加前后端参数映射关系。

使用场景：同一接口，在 API 网关定义不同的 API，以服务差异化的用户。通过 API 网关规范化陈旧的系统接口。

实现功能：支持您配置前端和后端的全映射，即参数混排。可以让 API 用户在 Query 中传入参数, 后端从 Header 里接收等。

支持：参数名称转换和参数位置转换。

可以定义参数的校验规则，实现请求参数的预校验，降低后端处理非法请求的压力。

支持：参数长度校验、参数数值大小校验、参数正则校验、和参数 JSON Schema 校验。

**入参透传：** 即 API 网关在接收到 API 请求后，不对请求进行处理，直接转发到后端服务。此模式下：无法实现参数校验、无法生成详细的 API 调用文件和自动生成的 SDK 不包含请求入参。

**入参请求定义：** 定义您 API 的请求入参，包含参数名、参数位置、类型、是否必填、默认值、示例、描述等信息。入参透传模式下，不需要录入参数。

| 填写项目 | 说明 |
|:-:|:-|
|参数名|展示给用户的参数名称。|
|参数位置|参数在请求中的位置，包含 Head、Query、和 Parameter Path。**注意:** 如果您在 Path 中配置了动态参数，存在参数位置为 Parameter Path 的同名参数。|
|类型|字段的类型，支持：String、Int、Long、Float、Double、和 Boolean。|
|必填|指此参数是否为必填。当选择为是时，API 网关会校验用户的请求中是否包含了此参数。若不包含此参数，则拒绝该请求。|
|默认值|当必填为否时生效。在用户请求中不包含此参数时，API 网关自动添加默认值发送给后端服务。|
|请求参数示例|指参数的填写示例。|

* 返回参数配置

返回参数的支持格式有三种，分别为JSON、TEXT和XML

返回参数定义类型可以为基本类型参数和实体类型参数。其中实体类型的管理详情见实体管理。
正确返回示例和错误返回示例根据业务需要进行配置。
错误码也可根据需要配置。

### 发布管理

已创建和配置好的 API，只有在发布后，才可以由使用者访问到，未发布的 release 环境的API，仅能进行内部的测试。API 发布后，将会获得外部访问地址，也可以从已绑定的用户域名上访问。在服务管理页签，选择【发布管理】，根据需要选择生产环境、灰度环境、测试环境进行发布。其中测试环境为开发者提供测试API的功能，在测试环境测试成功的API可以在灰度环境进行再次此时保证测试准确定。生产环境为正式环境，发布到生产环境的服务会直接上架到API中心。

![服务管理页面](/articles/apigateway/5-/images/img3.1.3-1.png)

* 发布

根据需要将服务进行发布到不同环境，发布完成后会产生新的版本。

* 下线

在具体某一环境发布后，如果需要撤销发布，可以在环境管理界面的操作中单击【下线】。在服务下线后，外部将无法访问到此环境上的服务。如果服务在一个环境中未发布，则不能下线。

* 测试

选择【测试】后，进入测试页面，根据提示输入参数进行测试。

![API测试页面](/articles/apigateway/5-/images/img3.1.3-2.png)

* 切换版本

发布完成后，可根据需要重新发布生成不同版本的服务，不同版本的服务可进行版本切换。您可以查看您每个 API 的发布历史记录，包括每次发布的版本号、说明、环境、时间和发布备注。查看历史时，您可以选定某个版本然后操作切换到此版本，该操作会使该版本直接在指定环境中替换之前的版本，实时生效。

![切换版本](/articles/apigateway/5-/images/img3.1.3-2-1.png)

* 查看历史版本

查看历史版本是为用户提供查看当前环境下发布过的版本信息。选择【查看历史版本】后，进入历史版本页面。

![历史版本查看](/articles/apigateway/5-/images/img3.1.3-3.png)

### 服务编辑

在服务管理页签，选择【编辑】按钮，可以对服务的基本信息和API信息进行修改。

### 服务删除

在服务管理页签，选择【删除】按钮，可以对服务进行删除。 

## 运维数据

运维数据是API网关提供了生产环境、灰度环境和测试环境的运维相关数据。

### 基本数据

运维数据中基本数据包括了当前环境下的服务数量、在线服务、下线服务和访问地址信息。其中服务数量是在线服务和下线服务的总和。当一条在线服务被删除后，会影响服务数量和在线服务数量。

### 调用次数统计

在运维数据页签，选择【查看详情】后，再选择【调用次数统计】，可以查看到当前环境下所有服务调用次数的统计。

### 数据监控

在运维数据页签，选择【查看详情】后，再选择【数据监控】，可以选择服务和API查询当天或者指定月的调用次数、调用字节数和调用时长。

### 日志查询

在运维数据页签，选择【查看详情】后，再选择【日志查询】，可以选择服务和API查询指定天的调用日志情况。

## 实体管理

实体管理是在增加API时，【返回参数配置】中增加实体对象参数时作为复杂类型参数使用。

* 新增实体

在实体管理页签，选择【增加实体】，填写实体名、实体描述信息，并根据需要添加实体属性。

![增加实体页面](/articles/apigateway/5-/images/img3.3.1.png)

* 编辑实体

在实体管理页签，选择【编辑】按钮，对实体进行编辑操作。

* 删除实体

在实体管理页签，选择【删除】按钮，对实体进行删除操作。

## 服务审核

API开发者创建服务时开通方式为手动时，使用者在申请服务时，需要开发者进行审核，此时使用者申请的应用不能被调用，直到申请被通过后才能进行服务调用操作。审批通过后会显示在审核通过列表，若审核不通过则显示在审核不通过列表。

![服务审核页面](/articles/apigateway/5-/images/img3.4.1.png)

## 流量控制

流量控制可配置 API 的流控，可按业务需要配置每秒支持调用 API 的次数，用以保障您业务的稳定性。在API开发者创建应用中的API时，可以进行API网关提供了三种方式的流量控制，分别为单位时间某个用户访问次数限制、某个API访问次数限制和网关流量控制。

### 用户流量限制

每个API网关账号对该策略绑定的任何一个 API 在单位时间内的调用次数不能超过设定值。一个API网关账号可能有多个 APP，所以对API网关账号的流量限制就是对该账号下所有 APP 的流量总和的限制。。

### API流量限制

该流量控制为单位时间某个API访问次数限制。

### 网关流量控制

网关级别的流量控制需要进入API网关的nginx进行配置

![API网关流量控制](/articles/apigateway/5-/images/img3.5.3-1.jpg)

其中参数如下：

| 参数 | 说明 |
|:-:|:-| 
|waf|网关拦截配置是否启动|
|RulePath|是指配置具体拦截规则地址|
|UrlDeny |是否启用Url拦截|
|Redirect |是否启用重定向拦截|
|CookieMatch |防Cookie攻击|
|PostMatch|Post请求参数过滤|
|CCDeny|是否启用防CC攻击|
|CCrate|CC攻击限流|

启动后具体的正则过滤规则配置文件如下：
 
![正则过滤规则配置文件](/articles/apigateway/5-/images/img3.5.3-2.jpg)
